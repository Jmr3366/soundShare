<!DOCTYPE html>
<html lang="en-au">
<head>
    <title>soundShare</title>
    <style>
        body { font-family: Verdana, Arial, Helvetica, sans-serif; position: relative; color: #222222; font-size: 1.0em;
         cursor: default;}
         .hidden{ display: none; }
         input:disabled { cursor: default; }
         .tj_audio_controls{
          border-radius: 0.7rem;
          border: 1px solid navy;
          display: inline-block;
          line-height:1rem;
          min-width: 1.6rem;
          text-align: center;
         }
         .tj_audio_controls.disabled { border: 1px solid grey; }
         .tj_audio_control{ color: blue; }
         .tj_audio_controls.disabled .tj_audio_control{
          cursor: default;
          color: grey;
         }
        .tj_audio_control:hover, .tj_copy:hover, .tj_checkbox:hover { cursor:pointer; }
        .tj_container ul { padding-inline-start: 1rem; }
        .tj_container li::marker { content: none; margin: 0; padding: 0; }
        .tj_icon { margin: 0 0.3rem; }

          input[type="checkbox"]{
            margin-right: 0.4rem;
            height:0.9rem;
            width: 0.9rem;
          }
    </style>
    <link type="text/css" href="css/treejs.min.css"/>
    <script type="text/javascript" src="js/treejs/tree.js"></script>
    <script type="text/javascript" src="js/jsonpath.js"></script>
    <!--script type="text/javascript" src="js/json2.js"></script -->
</head>
<body>
<h3>Sound-Share Links</h3>
<div id="tree"></div>

&#128203;
&#10697;
</body>
<script>
    'use strict'
  var dirListing;

  function fetchJSONData() {
    fetch("./treeList.json")
        .then((res) => {
            if (!res.ok) {
                throw new Error
                    (`HTTP error! Status: ${res.status}`);
            }
            return res.json();
        })
        .then((data) =>
             buildFileMap(data))
        .catch((error) =>
               console.error("Unable to fetch data:", error));
  }


  window.addEventListener("load", function(){
    dirListing = fetchJSONData();
  });

  let listItemStore = [];
  const template = document.getElementById("template");
  const tempBtn = document.getElementById("btn");
  function buildFileMap(json){
    let paths = jsonPath(json, "$..path");
    let dirs = Object.values(jsonPath(json, "$..[?(@.type==`tree`)].path"));
    let dirArr = filesToTreeNodes(paths, dirs);
    var root = new TreeNode("Audio"); // Create the root-node
    var tree = new TreeView(root, document.getElementById("tree"), {show_root:false});

    loopNodes(dirArr, root);

    function loopNodes(arrArr, node){
      for(let i = 0; i < arrArr.length; i++){
        let ob = arrArr[i];
        let n1 = new TreeNode(ob.fileName)
        let parentId;
        let parentOpt = node.getOptions();
        parentId = Object.hasOwn(parentOpt, "id") ? parentOpt.id : parentId = "";
        let childOpt = n1.getOptions();
        childOpt.id = parentId + (ob.isDirectory ? "D" + i : "N" + i);
        childOpt.fileName   = ob.fileName   ;
        childOpt.isDirectory= ob.isDirectory;
        childOpt.path       = ob.path       ;

        n1.setOptions(childOpt);
        n1.setOptions(makeNodeExtras(n1));
        node.setExpanded((childOpt.id.length - childOpt.id.replaceAll("D", "").length >= 2 || n1.getChildCount() > 7) ? false : true);

        n1.on("select", updateSelection(n1));
        n1.on("deselect", updateSelection(n1));

        node.addChild(n1);

        if(ob.isDirectory){
          loopNodes(arrArr[i].children, n1);
        }

      }
    }
    tree.reload();
  }
  function makeNodeExtras(node){
    let options = node.getOptions();

    const inputSelect = document.createElement("input");
    inputSelect.type = "checkbox";
    inputSelect.className = "tj_checkbox";
    inputSelect.id = options.id + "_checkbox";
    inputSelect.value = options.fileName;
    inputSelect.checked = false;
    options.checkbox = inputSelect;
    inputSelect.addEventListener("input", function(e){
        node.setSelected(e.target.checked);
        if(!node.isLeaf()){
            node.getChildren().forEach(function(child){
                child.getOptions().checkbox.checked = e.target.checked;
                child.setSelected(e.target.checked);
            });
        }
        updateList();
    }, false);
    inputSelect.addEventListener("input", buttonHandler);


    const copyButton = document.createElement("span");
    copyButton.id = options.id + "_copy";
    copyButton.classList.add("tj_copy");
    copyButton.classList.add("tj_icon");
    copyButton.innerHTML = TreeConfig.copy_icon;
    copyButton.firstElementChild.style.pointerEvents = "none";
    copyButton.dataset.value = "https://bubblobill.github.io/soundShare/audio/" + encodeURIComponent(options.path);
    copyButton.title = "Copy link to clipboard";
    copyButton.addEventListener("pointerdown", buttonHandler);

    options.copy = copyButton;
    if(options.isDirectory){
        options.player = null;
        options.controls = null;
        options.play = null;
        options.pause = null;
    } else {
        const player = new Audio(copyButton.dataset.value);
        player.id  = options.id + "_audio";
        player.className  = "tj_audio";
        player.preload = false;
        player.controls = false;
        options.player = player;

        const controls = document.createElement("span");
        controls.id = player.id + "_controls";
        controls.classList.add("tj_audio_controls");
          const play = document.createElement("font");
          play.id = controls.id + "_play";
          play.innerHTML = "&#127900;";
          play.classList.add ("tj_audio_control");
          play.title = "Play sound"

          const pause = document.createElement("font");
          pause.innerHTML = "&#9208;";
          pause.id = controls.id + "_pause";
          pause.classList.add ("tj_audio_control");
          pause.classList.add("hidden");
          pause.title = "Pause sound";

          controls.appendChild(play);
          controls.appendChild(pause);
          options.controls = controls;

          play.addEventListener("pointerup", buttonHandler);
          pause.addEventListener("pointerup", buttonHandler);
          player.addEventListener("error", (event) => {
              controls.classList.add("disabled");
              play.title = "Link broken";
              play.removeEventListener("click", buttonHandler);
              pause.removeEventListener("click", buttonHandler);
              copyButton.removeEventListener("click", buttonHandler);
              inputSelect.selected = false;
              inputSelect.value = "";
              inputSelect.disabled = true;
            }, false);
    }
    return options;
  }
  function updateSelection(node){
    let cb = document.getElementById(node.getOptions() + "_checkbox");
    if(cb != undefined && cb != null && node != undefined){
      cb.selected = node.isSelected();
    }
  };

  function filesToTreeNodes(arr, dirs) {
    var tree = {}
    function addNode(obj) {
      var splitPath = obj.replace(/^\/|\/$/g, "").split('/');
      var ptr = tree;
      for (let i = 0; i < splitPath.length; i++) {
        let node = {
          fileName: splitPath[i],
          path: obj,
          isDirectory: false
        };
        if (dirs.includes(obj)) {
          node.isDirectory = true
        }
        ptr[splitPath[i]] = ptr[splitPath[i]] || node;
        ptr[splitPath[i]].children = ptr[splitPath[i]].children || {};
        ptr = ptr[splitPath[i]].children;
      }
    }
    function objectToArr(node) {
      Object.keys(node || {}).map((k) => {
        if (node[k].children) {
          objectToArr(node[k])
        }
      })
      if (node.children) {
        node.children = Object.values(node.children)
        node.children.forEach(objectToArr)
      }
    }
    arr.map(addNode);
    objectToArr(tree)
    return Object.values(tree)
  }

  function togglePlayPause(el, off = false){
    if(off){
      el.firstElementChild.classList.remove("hidden");
      el.lastElementChild.classList.add("hidden");
    } else {
     el.firstElementChild.classList.add("hidden");
     el.lastElementChild.classList.remove("hidden");
    }
  }

  function buttonHandler(e){
    const t = e.target;
    if(t.id.includes("audio_controls")){
      const player = document.getElementById(t.id.replace("_controls_pause", "").replace("_controls_play", ""));
      if(t.id.includes("play")){
        if(player.ended || player.paused && player.readyState >= 2){
          player.play();
          player.addEventListener("ended", (event) => {
            togglePlayPause(t.parentElement, true);
          });
          togglePlayPause(t.parentElement, false);
          return;
        } else {
          return;
        }
      } else {
        if(player.paused){
         return;
        } else if(!player.ended || player.error != null){
          player.pause();
          return;
        }
      }
    }
    if(t.id.includes("_copy")){
        if(e.type === "pointerdown"){
            t.classList.add("pointerDown");
            t.addEventListener("pointerup", buttonHandler);
            t.addEventListener("pointerleave", function(evt){
                t.classList.remove("pointerDown");
                t.removeEventListener("pointerup", buttonHandler);
            }, false);
            return;
        } else if(e.type === "pointerup"){
            navigator.clipboard.writeText(t.dataset.value);
            t.removeEventListener("pointerup", buttonHandler);
            const msg = document.createElement("span");
            msg.classList.add("notification");
            msg.innerText = "Link copied";
            t.insertAdjacentElement("afterend", msg);
            setTimeout(function(){msg.remove();}, 3000);
            return;
        }
        return;
    }
    //console.log(e);
  }
    function updateList(){

    }
</script>
</html>
